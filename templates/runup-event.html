{% extends theme("layout.html") %}
{% from "baseframe/forms.html" import ajaxform %}
{% from theme("data/runup-event.html") import items %}
{% set event = items[node.properties['event_id']|int] %}

{% set title = 'Run-up events' %}
{% set description = node.description %}
{% set banner_title_size = 'huge' %}

{% block banner_title %}
  <hr class="half center-block space-three-top space-three-bottom">
  <h1 class="clearboth centered calm measure-10words center-block space-three-top {% if banner_title_size %}{{ banner_title_size }}{% else %}giant{% endif %}"><div class="serif-type italic legible occupy capitalize space-one-bottom">{{ event.city }} Run-up</div><div class="title-type large calm darkblue">{{ event.title|safe }}</div>
  </h1>
  <h2 class="space-three-bottom"><span class="orange legible semi-bold">{{ event.date|safe }}</span><br><span class="regular body-type semi-bold all-caps"><img alt="Co-ordinates" src="/_themes/fifthelephant2014/img/map-marker.svg" width="15" class="gap-1q-right white"> {{ event.venue.name }}</span></h2>
{% endblock %}

{% block networkbar %}{{ networkbar(siteid='events', login=true) }}{% endblock %}

{% macro rsvp_form(node, form, waitlist=False, hascapacity=True, status='U') %}
  <form id="rsvp" action="{{ node.url_for('rsvp') }}" class="form-inline" method="POST">
    {{ form.hidden_tag() }}
    <p class="centered space-three-top space-two-bottom">
      {%- if waitlist %}
        {%- if status in ['Y', 'M', 'W'] %}
          <button name="status" value="N" class="button">Withdraw</button>
        {%- endif %}
        {%- if status in ['N', 'M', 'U'] %}
          <button name="status" value="Y" class="button">Add to waiting list</button>
        {%- endif %}
      {%- else %}
        {%- if hascapacity %}
          <button name="status" value="Y" class="button">Yes</button>
        {%- endif %}
          <button name="status" value="N" class="button">No</button>
        {%- if node.allow_maybe %}
          <button name="status" value="M" class="button">Maybe</button>
        {%- endif %}
      {%- endif %}
      <span class="loading hidden">&nbsp;</span>
    </p>
    {%- if status != 'U' %}
      <p class="centered">
        <span class="ultrafaded">Your status:</span>
        {%- if status == 'Y' %} <span class="green">Attending</span>
        {%- elif status == 'N' %} <span class="red">Not attending</span>
        {%- elif status == 'M' %} <span class="blue">Maybe attending</span>
        {%- elif status == 'W' %} <span class="orange">Wait-listed</span>
        {% else %} Unknown {%- endif %}
      </p>
    {%- endif %}
  </form>
{% endmacro %}

{% block banner_title_prefix %}{% endblock %}

{% block image_banner %}
<p class="runup-banner center-block ir space-two-top">Community</p>
{% endblock %}

{% block page_nav_items %}
  <li><a href="#preface" class="link-white-hover">About</a></li>
  {% if event.schedule %}
  <li><a href="#sessions" class="link-white-hover">{{ event.format|safe }}</a></li>
  <li><a href="#schedule" class="link-white-hover">Schedule</a></li>
  {% endif %}
  {% if event.venue.address %}
  <li><a href="#venue" class="link-white-hover">Venue</a></li>
  {% endif %}
  <li><a href="#rsvp-section" class="link-white-hover">RSVP</a></li>
  {% if event.venue.address %}
  <li><a href="#sponsor" class="link-white-hover">Sponsors</a></li>
  {% endif %}
{% endblock %}

{% block content %}
  <section class="legible prose space-six-top pad-one" id="preface">
    <article> 
      <section class="preface">
        <h2 class="visuallyhidden">Preface</h2>
        <div class="measure-8words center-block">
          {{ event.blurb|safe }}
        </div>
      </section> 
    </article>
  </section>

  {% if event.schedule %}
  <section id="sessions" class="space-four-top fill-light legible clearfix">
    {% for item in event.schedule %}
      {% if loop.first %}
      <article class="push-three-top push-two-bottom highlight-links clearfix">
        <h3 class="centered calm space-two-top nospace-bottom ultrafaded capitalize">{{ event.format|safe }}</h3>
        <ul class="featured-sessions poster-with-bio legible clearfix nospace">
      {% endif %}
      {% if item.speaker %}
          <li class="clearfix">
            <h3 class="featured-session-topic calm space-two-top">{{ item.title|safe }} <span class="ultrafaded">[ {{ item.type }} ]</span></h3>
            <div class="featured-session-description center-block regular clearfix">{{ item.description|safe }}</div>
            {% if item.requirement %}          
            <div class="featured-session-description center-block regular clearfix push-one-top push-two-bottom">
              <h4 class="all-caps secondary">Requirements</h4>
              {{ item.requirement|safe }}
            </div> 
            {% endif %}  
          </li>
      {% endif %}
      {% if loop.last %}
        </ul>
      </article>
      {% endif %}
    {% endfor %}
  </section>

  <section id="schedule" class="schedule push-three-top legible">
    <h2 class="centered calm space-three-bottom">Schedule</h2>
    <div class="schedule-table-container center-block pad-one regular">
      <table class="schedule-table">
        <thead>
          <tr>
            <th class="time semi-bold">Time</th>
            <th colspan="2" class="track-1 semi-bold">Sessions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in event.schedule %}
            <tr>
              <th class="time" scope="row">{{ item.slot }}</th>
              <td colspan="2" class="centered">
              {% if item.speaker %}
                <h4><span class="capitalize semi-bold">{{ item.type }}</span>: <span class="calm orange">{{ item.title|safe }}</span></h4>
                <p>{{ item.speaker }}</p>
              {% else %}
                {{ item.title|safe }}
              {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}

  {% if event.venue.address %}
  <section id="venue" class="legible conference-venue space-two-top space-four-bottom push-four-top">
    <article class="legible">
      <hgroup class="space-two-bottom">
        <h1 class="calm centered nospace large">Venue</h1>
        <h2 class="calm centered space-half-top nospace-bottom ultrafaded legible">{{ event.venue.name }}</h2>
      </hgroup>
      <section>
        <div class="venue-showcase conference-venue contain-width clearfix">
          <p class="full">
          <img  class="venuephoto occupy" style="width:50%; margin: 0 auto;"
                  src="{{ event.venue.poster }}"
                  alt="{{ event.venue.name }}">
          </p>
        </div>
        <div class="measure-10words regular prose center-block pad-one space-two-top">
          <h4 class="space-two-top nospace-bottom">When</h4>
          <p class="space-half">{{ event.date|safe }}, {{ event.time|safe }}</p>
          <h4 class="space-two-top nospace-bottom">Address</h4>
            <p class="space-half">
            {{ event.venue.address|safe }}
            </p>
          <p class="secondary space-half-top space-two-bottom"><a href="{{ event.venue.map_link }}">View on Google Maps</a></p>
        </div>
        <div class="map-container measure-10words center-block legible clearfix links-prevent-hover-highlight"><div id="venue-map" class="map"></div></div>
      </section>
    </article>
  </section>
  {% endif %}

  <section id="rsvp-section" class="space-four-top fill-light legible clearfix">
    <article class="push-two-top push-two-bottom highlight-links clearfix">
      <h3 class="centered calm space-two-top space-three-bottom">RSVP</h3>
      <div class="center-block measure-8words">
        <div class="box section">
          {%- if g.user %}            
            {%- if node.can_rsvp(g.user) %}
              {%- with status = node.get_status(g.user) %}
                {%- if node.has_capacity() %}
                  <p>
                    {% if node.capacity > 0 -%} The venue has limited capacity. {% endif -%}
                    Will you be attending? Please RSVP to confirm your presence:
                  </p>
                  {{ rsvp_form(node, form, status=status) }}
                {%- else %}
                  {%- if node.allow_waitlisting %}
                    <p>
                      This session is fully booked, but you can place yourself in the wait list in case someone drops out.
                    </p>
                    {{ rsvp_form(node, form, waitlist=True, status=status) }}
                  {%- else %}
                    <p>This session is fully booked.</p>
                    {%- if status in ['N', 'M'] %}
                      {{ rsvp_form(node, form, hascapacity=False, status=status) }}
                    {%- endif %}
                  {%- endif %}
                 {%- endif %}
              {%- endwith %}
            {%- else %}
              <p>
                We donâ€™t have an email address on your profile matching your ticket.
                Please <a href="https://auth.hasgeek.com/profile/email/new" target="_blank">add the email address</a>
                you used when buying your ticket, <a href="{{ url_for('logout') }}">logout</a>
                and <a href="{{ url_for('login') }}">login</a> again.
              </p>
            {%- endif %}
          {%- else %}
            <p>
              {#{% if node.capacity > 0 -%} The venue has limited capacity. {% endif -%}#}
              Interested in attending? Please login. You can use your existing Twitter or Google account, and if you have previously voted on a session proposal or attended a hacknight, you already have a HasGeek account.
            </p>
            <p class="centered">
              <a href="{{ url_for('login') }}" class="button small-button">Login with Twitter, Google or HasGeek id</a>
            </p>
          {%- endif %}
        </div>    
      </div> 
    </article>
  </section>

  {% if event.sponsors %}
  <section id="sponsor" class="partners clearfix space-three">  
    <article class=" legible push-three-top push-two-bottom clearfix">
      <h3 class="centered calm space-two-bottom space-three-top nospace ultrafaded">Sponsor</h3>
      <ul class="centered regular clearfix v-middle nospace center-block links-prevent-hover-highlight">
        {% for sponsor in event.sponsors %}
        <li class="clearfix {% if sponsor.contain == 'height' %}contain-height{% else %}contain-width thirtyfive{% endif %}{% if event.sponsors|length <= 3 %} inline-block{% endif%}"><a class="occupy centered {% if event.sponsors|length <= 3 %} pad-two{% endif%}" href="{{ sponsor.url }}"><img src="{{sponsor.logo}}" alt="{{ sponsor.name }}"></a></li>
        {% endfor %}
      </ul>
    </article>
  </section>
  {% endif %}
{% endblock %}
{% block sponsor_compact %}{% endblock %}

{% block footer_script %}
  <script type="text/javascript">
  function initMap(div, map_venue, map_center) {
    var map = new L.Map(div);
    var cloudmadeUrl = 'http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png',
      subDomains = ['otile1','otile2','otile3','otile4'],
      cloudmadeAttrib = '<a href="http://open.mapquest.co.uk" target="_blank">MapQuest</a>, <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> and contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_blank">CC-BY-SA</a>';
    var cloudmade = new L.TileLayer(cloudmadeUrl, {maxZoom: 18, attribution: cloudmadeAttrib, subdomains: subDomains});
    var   venue = new L.LatLng(map_venue.lat, map_venue.lon)
        , center = new L.LatLng(map_center.lat, map_center.lon)
        ;
    map.setView(center, 13).addLayer(cloudmade);
    if ($(window).width() < 768) map.setView(venue,13);
    // map.dragging.disable(); 
    var marker = new L.Marker(venue);
    map.addLayer(marker);
    marker.bindPopup(map_venue.name);
    marker.openPopup();
    map.scrollWheelZoom.disable();
    map.doubleClickZoom.disable();
    map.on('zoomend', onZoomend);
    function onZoomend(){ map.setView(venue, map.getZoom()); };
  }
  $(function() {
    initMap('venue-map', { lat: {{ event.venue.map_lat }}, lon: {{ event.venue.map_long }}, name: '{{ event.venue.name }}' }, { lat: {{ event.venue.map_lat }}, lon: {{ event.venue.map_long }} });
  });
  </script>
  {{ ajaxform('rsvp', request, force=True) }}
{% endblock %}

